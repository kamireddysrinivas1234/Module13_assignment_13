name: ci

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        env:
          DATABASE_URL: sqlite:///./ci_test.db
        run: |
          pytest -q

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node deps + Playwright
        run: |
          npm install
          npx playwright install --with-deps

      - name: Build & start services (db + api)
        run: |
          docker compose up -d --build

      - name: Wait for API health
        run: |
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8000/health > /dev/null; then
              echo "API is healthy"
              exit 0
            fi
            echo "Waiting for API..."
            sleep 2
          done
          echo "API did not become healthy in time"
          docker compose logs api
          exit 1

      - name: Run Playwright E2E tests
        env:
          BASE_URL: http://127.0.0.1:8000
        run: |
          npm run e2e

      - name: Docker Hub login
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: srinivaskamireddy
          password: Srinivas@1234

      - name: Build and push image to Docker Hub
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: srinivaskamireddy/jwt-auth-fastapi-playwright:latest

      - name: Tear down
        if: always()
        run: |
          docker compose down -v
